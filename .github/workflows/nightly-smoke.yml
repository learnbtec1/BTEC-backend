name: Nightly Smoke Tests

on:
  schedule:
    # Run at 01:00, 03:00, 05:00, and 07:00 UTC
    - cron: '0 1,3,5,7 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.4.15"
          enable-cache: true
      
      - name: Start services
        run: |
          docker compose down -v --remove-orphans
          docker compose up -d db mailcatcher
      
      - name: Wait for database
        run: |
          timeout 30 bash -c 'until docker compose exec -T db pg_isready -U postgres; do sleep 1; done'
      
      - name: Install dependencies
        working-directory: backend
        run: |
          uv sync
      
      - name: Run migrations
        working-directory: backend
        run: |
          uv run bash scripts/prestart.sh
      
      - name: Seed demo data
        working-directory: backend
        run: |
          uv run python scripts/seed_demo.py
      
      - name: Start backend server in background
        working-directory: backend
        run: |
          uv run fastapi run app/main.py --port 8000 &
          sleep 10
      
      - name: Wait for server to be ready
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:8000/api/v1/openapi.json > /dev/null 2>&1; do sleep 1; done'
      
      - name: Health check
        run: |
          curl -f http://localhost:8000/api/v1/openapi.json || exit 1
          echo "✓ Server is healthy"
      
      - name: Test user registration
        run: |
          RESPONSE=$(curl -s -X POST "http://localhost:8000/api/v1/login/register" \
            -H "Content-Type: application/json" \
            -d '{
              "email": "smoketest@example.com",
              "password": "testpass123",
              "full_name": "Smoke Test User"
            }')
          echo "Registration response: $RESPONSE"
          echo "$RESPONSE" | grep -q "email" || exit 1
          echo "✓ User registration successful"
      
      - name: Test login and get token
        run: |
          RESPONSE=$(curl -s -X POST "http://localhost:8000/api/v1/login/access-token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=student1@example.com&password=student123")
          echo "Login response: $RESPONSE"
          TOKEN=$(echo "$RESPONSE" | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)
          if [ -z "$TOKEN" ]; then
            echo "❌ Failed to get access token"
            exit 1
          fi
          echo "✓ Login successful, token obtained"
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
      
      - name: Test assistant query
        run: |
          RESPONSE=$(curl -s -X POST "http://localhost:8000/api/v1/assistant/query" \
            -H "Authorization: Bearer ${{ env.TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "prompt": "Help me with my progress",
              "context": null
            }')
          echo "Assistant response: $RESPONSE"
          echo "$RESPONSE" | grep -q "answer" || exit 1
          echo "$RESPONSE" | grep -q "recommendations" || exit 1
          echo "✓ Assistant query successful"
      
      - name: Create test file for upload
        run: |
          echo "This is a smoke test file" > /tmp/smoke_test_file.txt
      
      - name: Test file upload
        run: |
          RESPONSE=$(curl -s -X POST "http://localhost:8000/api/v1/files/upload" \
            -H "Authorization: Bearer ${{ env.TOKEN }}" \
            -F "file=@/tmp/smoke_test_file.txt")
          echo "Upload response: $RESPONSE"
          echo "$RESPONSE" | grep -q "original_filename" || exit 1
          FILE_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*' | cut -d'"' -f4)
          echo "FILE_ID=$FILE_ID" >> $GITHUB_ENV
          echo "✓ File upload successful"
      
      - name: Test file listing
        run: |
          RESPONSE=$(curl -s -X GET "http://localhost:8000/api/v1/files" \
            -H "Authorization: Bearer ${{ env.TOKEN }}")
          echo "File list response: $RESPONSE"
          echo "$RESPONSE" | grep -q "smoke_test_file.txt" || exit 1
          echo "✓ File listing successful"
      
      - name: Test file download
        run: |
          if [ -n "${{ env.FILE_ID }}" ]; then
            curl -s -X GET "http://localhost:8000/api/v1/files/${{ env.FILE_ID }}" \
              -H "Authorization: Bearer ${{ env.TOKEN }}" \
              -o /tmp/downloaded_file.txt
            if [ -f /tmp/downloaded_file.txt ]; then
              echo "✓ File download successful"
            else
              echo "❌ File download failed"
              exit 1
            fi
          fi
      
      - name: Run backend tests
        working-directory: backend
        run: |
          uv run pytest tests/ -v --tb=short
      
      - name: Report smoke test results
        if: always()
        run: |
          echo "=== Smoke Test Summary ==="
          echo "Run at: $(date -u)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          if [ $? -eq 0 ]; then
            echo "Status: ✓ All smoke tests passed"
          else
            echo "Status: ❌ Some smoke tests failed"
          fi
      
      - name: Cleanup
        if: always()
        run: |
          docker compose down -v --remove-orphans
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Nightly smoke tests failed - ${new Date().toISOString().split('T')[0]}`,
              body: `Automated smoke tests failed at ${new Date().toISOString()}\n\nCommit: ${context.sha}\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['automated-test', 'smoke-test-failure']
            })
